<body id="drop-area">
  <h1 align="center">ORT Profiling Analyzer</h1>
  <b>[Usage]</b>
  <p>Please drop your JSON file here</p>
  <p>Some parameters are supported in url, and you may use them as '?key0=value0&key1=value1...'. Supported parameters
    are:
  </p>
  <p>index: Run index. Default is 1.</p>

  <b>[Info]</b>
  <p id="info"></p>
  <link href="sortable.min.css" rel="stylesheet" />
  <script src="sortable.min.js"></script>
  <script src="util.js"></script>
  <script>
    "use strict";

    let cpuProfilingData;
    let gpuProfilingData;
    let index;
    let sessionCount;
    let sessionStartKernelId;

    const dropArea = document.getElementById('drop-area');
    const indexParam = getParam("index", "Number", 1);
    const reNative = /\[.*\] "(\{"cat".*)", source:.*/;
    const reWeb = /\[profiling\] kernel \"(.*)\" (input.*), execution time\: (\d+) ns/;
    const unitConversionFactor = 1000000;

    dropArea.addEventListener('dragover', (event) => {
      event.stopPropagation();
      event.preventDefault();
      event.dataTransfer.dropEffect = 'copy';
    });

    dropArea.addEventListener('drop', (event) => {
      event.stopPropagation();
      event.preventDefault();
      const file = event.dataTransfer.files[0];
      readFile(file);
    });

    function isJson(str) {
      try {
        JSON.parse(str);
      } catch (e) {
        return false;
      }
      return true;
    }

    function readFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          cpuProfilingData = [];
          gpuProfilingData = [];
          index = 0;
          sessionCount = 0;
          sessionStartKernelId = '';

          let dataSource = '';

          if (isJson(e.target.result)) {
            dataSource = 'native';
            handleNativeData(e.target.result);
          } else {
            let lines = e.target.result.split('\n');
            let newLines = [];

            for (let line of lines) {
              let matchNative = line.match(reNative);
              let matchWeb = line.match(reWeb);

              if (matchNative) {
                if (dataSource === '') {
                  dataSource = 'native';
                }
                newLines.push(matchNative[1]);
              } else if (matchWeb) {
                if (dataSource === '') {
                  dataSource = 'web';
                }
                newLines.push(matchWeb[0]);
              }
            }

            if (dataSource === 'native') {
              newLines.unshift('[');
              newLines.push(']');
              handleNativeData(JSON.parse(newLines.join('')));
            } else {
              handleWebData(newLines);
            }
          }
        } catch (error) {
          console.error('Could not parse the file as json:', error);
        }
      };
      reader.readAsText(file);
    }

    function handleNativeData(data) {
      let isNewSession = false;
      let gpuProfilingDataFlat = [];
      for (let line of data) {
        if (line['cat'] === 'Session') {
          isNewSession = true;
          continue;
        } else if (line['cat'] === 'Node') {
          if (isNewSession) {
            isNewSession = false;
            sessionCount++;
            cpuProfilingData.push([]);
          }
          if (!('provider' in line['args'])) {
            continue;
          }
          cpuProfilingData[sessionCount - 1].push([index++, line['args']['op_name'], line['dur'] / 1000, `input_type_shape: ${JSON.stringify(line['args']['input_type_shape'])}, output_type_shape: ${JSON.stringify(line['args']['output_type_shape'])}`, line['args']['provider'].replace('ExecutionProvider', '')]);
        } else if (line['cat'] === 'Api') {
          let names = line['name'].split('/').pop().split('&');
          let kernelType = names[1];
          let programName = names[2];
          let kernelName;
          if (kernelType === programName) {
            kernelName = programName;
          } else {
            kernelName = `${kernelType}|${programName}`;
          }
          gpuProfilingDataFlat.push([kernelName, line['dur'] / 1000, JSON.stringify(line['args']['shapes'])]);
        }
      }

      let sessionIndex = -1;
      let countPerSession = gpuProfilingDataFlat.length / sessionCount;
      for (let i = 0; i < gpuProfilingDataFlat.length; i++) {
        if (i >= sessionIndex * countPerSession) {
          sessionIndex++;
          gpuProfilingData.push([]);
          index = 0;
        }
        gpuProfilingData[sessionIndex].push([index++, ...gpuProfilingDataFlat[i]]);
      }

      displayData();
    }

    function handleWebData(lines) {
      for (let line of lines) {
        let matchWeb = line.match(reWeb);

        let kernelName = "";
        const kernelInfo = matchWeb[1].split("|");
        const kernelId = kernelInfo[0];
        if (sessionStartKernelId === '') {
          sessionStartKernelId = kernelId;
          gpuProfilingData.push([]);
        }
        if (kernelId === sessionStartKernelId) {
          sessionCount++;
          gpuProfilingData.push([]);
        }
        const opType = kernelInfo[1];
        const programName = kernelInfo[kernelInfo.length - 1];
        if (opType == programName) {
          kernelName = opType;
        } else {
          kernelName = `${opType}|${programName}`;
        }
        gpuProfilingData[sessionCount - 1].push([index++, kernelName, parseInt(matchWeb[3]) / unitConversionFactor, matchWeb[2]]);
      }
      displayData();
    }

    function displayData() {
      const replacables = document.querySelectorAll('.replacable');
      replacables.forEach(replacable => {
        replacable.remove();
      });

      document.getElementById('info').innerHTML = `Run Times: ${sessionCount}, Current Run: ${indexParam}`;

      if (gpuProfilingData.length > 0) {
        renderAggregatedData(["Kernel", "Time (ms)", "Percentage (%)"], gpuProfilingData[indexParam], 'GPU Aggregated Profiling Data');
      }
      if (cpuProfilingData.length > 0) {
        renderAggregatedData(["Kernel", "Time (ms)", "Percentage (%)"], cpuProfilingData[indexParam], 'CPU Aggregated Profiling Data');
      }
      if (gpuProfilingData.length > 0) {
        renderData(["Index", "Kernel", "Time (ms)", "Shape"], gpuProfilingData[indexParam], 'GPU Profiling Data');
      }
      if (cpuProfilingData.length > 0) {
        renderData(["Index", "Kernel", "Time (ms)", "Shape", "Provider"], cpuProfilingData[indexParam], 'CPU Profiling Data');
      }
    }
  </script>
</body>